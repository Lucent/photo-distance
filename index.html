<!doctype html>
<html>
<head><!--
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>-->
<script src="js-md5/src/md5.js"></script>
<script src="exif-js/exif.js"></script>
<script>
"use strict";
function display_loaded(file, specs) {
	console.log(file.name + " size " + file.size + " from " + file.lastModified);
	console.log(specs);
}

function to_dms(latitude, cardinal) {
	var flip;
	if (!latitude)
		return;

	if (cardinal === "N" || cardinal === "E")
		flip = 1;
	else
		flip = -1;

	return (latitude[0] + latitude[1] / 60 + latitude[2] / (60*60)) * flip;
}

function get_alt(altitude, sign) {
	if (!altitude)
		return;

	return altitude * (sign ? -1 : 1);
}

function batch_uploaded() {
	const image_array = Array.from(image_hash);

	for (let pointer = 0; pointer < image_array.length; pointer++) {
		let hash1 = image_array[pointer][0];
		let specs1 = image_array[pointer][1];
		if (!specs1.lat || !specs1.lon) continue;

		for (let inner = pointer + 1; inner < image_array.length; inner++) {
			let hash2 = image_array[inner][0];
			let specs2 = image_array[inner][1];
			if (!specs2.lat || !specs2.lon) continue;

			let key = hash_pair_to_key(hash1, hash2);
			let dist = distance_haversine(specs1.lat, specs1.lon, specs2.lat, specs2.lon);
			distance_grid.set(key, dist);
		}
	}

	console.log(distance_grid);
	let distance_array = Array.from(distance_grid);
	distance_array = distance_array.sort(distance_sort);
	const distance_map = new Map(distance_array);

	for (const [hash, dist] of distance_map) {
//		console.log(dist);
	}
}

function distance_sort(a, b) {
	return a[1] - b[1];
}

function hash_pair_to_key(hash1, hash2) {
	const sorted = [hash1, hash2].sort();
	return JSON.stringify(sorted);
}

Number.prototype.toRadians = function() { return this * Math.PI / 180; };

function distance_haversine(lat1, lon1, lat2, lon2) {
	const R = 6371e3; // metres
	const X1 = lat1.toRadians();
	const X2 = lat2.toRadians();
	const dX = (lat2-lat1).toRadians();
	const dy = (lon2-lon1).toRadians();

	const a = Math.sin(dX/2) * Math.sin(dX/2) +
			Math.cos(X1) * Math.cos(X2) * Math.sin(dy/2) * Math.sin(dy/2);
	const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

	const d = R * c;
	return d;
}

const image_hash = new Map();
const distance_grid = new Map();

const read_uploaded_file = (file) => {
	if (!FileReader || !(/image/i).test(file.type))
		return;

	const binaryReader = new FileReader();

	return new Promise((resolve, reject) => {
		binaryReader.onerror = () => {
			binaryReader.abort();
			reject(new DOMException("Problem parsing input file."));
		};

		binaryReader.onloadend = () => {
//			const textenc = new TextDecoder();
			const first_64 = binaryReader.result.slice(0, 2**16 - 1 + 100);
			const exif = EXIF.readFromBinaryFile(first_64);
			const hash = md5(first_64);
			if (!image_hash.has(hash)) {
				const specs = {
					"name": file.name,
					"time": exif["DateTime"],
					"lat": to_dms(exif["GPSLatitude"], exif["GPSLatitudeRef"]),
					"lon": to_dms(exif["GPSLongitude"], exif["GPSLongitudeRef"]),
					"alt": get_alt(exif["GPSAltitude"], exif["GPSAltitudeRef"])
				};
			//	console.log(specs);
				image_hash.set(hash, specs);
			}
			resolve();
		};
		binaryReader.readAsArrayBuffer(file);
	});
};

function traverseFiles(files) {
	if (typeof files !== "undefined") {
		const file_array = Array.from(files);
		Promise.all(file_array.map(file => read_uploaded_file(file))).then(batch_uploaded);
	}
}

window.onload = function() {
	var filesUpload = document.getElementById("files-upload"),
		dropArea = document.getElementById("drop-area"),
		fileList = document.getElementById("file-list");

	filesUpload.addEventListener("change", function () {
		traverseFiles(this.files);
	}, false);

	dropArea.addEventListener("dragleave", function (evt) {
		var target = evt.target;

		if (target && target === dropArea)
			this.className = "";
		evt.preventDefault();
		evt.stopPropagation();
	}, false);

	dropArea.addEventListener("dragenter", function (evt) {
		this.className = "over";
		evt.preventDefault();
		evt.stopPropagation();
	}, false);

	dropArea.addEventListener("dragover", function (evt) {
		evt.preventDefault();
		evt.stopPropagation();
	}, false);

	dropArea.addEventListener("drop", function (evt) {
		traverseFiles(evt.dataTransfer.files);
		this.className = "";
		evt.preventDefault();
		evt.stopPropagation();
	}, false);
}
</script>
<style>
#drop-area	{ display: block; width: 25%; height: 25em; border: thick dashed gray; }
</style>
</head>
<body>
<h1>Choose file(s)</h1>
<p>
	<input id="files-upload" type="file" multiple>
</p>
<p id="drop-area">
	<span class="drop-instructions">or drag and drop files here</span>
	<span class="drop-over">Drop files here!</span>
</p>

<ul id="file-list">
	<li class="no-items">(no files uploaded yet)</li>
</ul>
</body>
</html>
